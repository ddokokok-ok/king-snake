<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSCode Snake - è´ªåƒè›‡æ¸¸æˆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Consolas:wght@400;700&display=swap');

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: #1e1e1e;
            font-family: 'Consolas', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            color: #cccccc;
            overflow: hidden;
        }

        .vscode-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 48px;
            background: #252526;
            border-right: 1px solid #3c3c3c;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
        }

        .sidebar-icon {
            width: 32px;
            height: 32px;
            margin: 4px 0;
            background: #3c3c3c;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-icon:hover {
            background: #3e3e42;
        }

        .sidebar-icon.active {
            background: #094771;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .title-bar {
            height: 35px;
            background: #323233;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-bottom: 1px solid #3c3c3c;
        }

        .title-bar-item {
            margin-right: 10px;
            font-size: 13px;
            cursor: pointer;
        }

        .title-bar-item.active {
            background: #1e1e1e;
            padding: 2px 8px;
            border-radius: 3px;
        }

        .activity-bar {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background: #252526;
            border-bottom: 1px solid #3c3c3c;
            font-size: 13px;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 3px;
        }

        .game-title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-title {
            font-size: 16px;
            font-weight: 600;
            color: #cccccc;
            margin-bottom: 5px;
        }

        .player-title {
            font-size: 12px;
            color: #ffd700;
            font-weight: 600;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            animation: titleGlow 2s ease-in-out infinite;
        }

        .game-difficulty {
            font-size: 11px;
            color: #0e639c;
            margin-top: 3px;
            font-weight: bold;
        }

        @keyframes titleGlow {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .game-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            font-size: 13px;
            color: #cccccc;
        }

        .stat-label {
            color: #858585;
        }

        .stat-value {
            color: #4ec9b0;
            font-weight: 600;
        }

        .game-area {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 3px;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        canvas {
            border: 1px solid #3e3e42;
            background: #1e1e1e;
            border-radius: 3px;
        }

        .controls {
            margin-top: 20px;
            padding: 15px;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 3px;
        }

        .control-title {
            font-size: 14px;
            margin-bottom: 10px;
            color: #cccccc;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .vscode-button {
            padding: 6px 12px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .vscode-button:hover {
            background: #1177bb;
        }

        .vscode-button:active {
            background: #0e5a8a;
        }

        .vscode-button.secondary {
            background: #3e3e42;
        }

        .vscode-button.secondary:hover {
            background: #4e4e52;
        }

        .controls-info {
            font-size: 12px;
            color: #858585;
            line-height: 1.5;
        }

        .game-over, .level-up {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.95);
            padding: 20px 30px;
            border-radius: 5px;
            border: 1px solid #3e3e42;
            text-align: center;
            z-index: 1000;
        }

        .game-over {
            background: #252526;
            border: 2px solid #3e3e42;
            border-radius: 8px;
            padding: 30px;
            color: #ffffff;
            text-align: center;
            display: none;
            min-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 5000;
        }

        .game-over-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .game-over-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            gap: 20px;
        }

        .final-score, .final-level {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 15px;
            flex: 1;
        }

        .score-label, .level-label {
            font-size: 12px;
            color: #858585;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .score-value, .level-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ecdc4;
        }

        .game-over-leaderboard {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }

        .leaderboard-preview-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffd700;
            text-align: center;
        }

        .leaderboard-preview-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .leaderboard-preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #3e3e42;
            font-size: 14px;
        }

        .leaderboard-preview-item:last-child {
            border-bottom: none;
        }

        .leaderboard-preview-rank {
            font-weight: bold;
            color: #ffd700;
            width: 20px;
        }

        .leaderboard-preview-name {
            flex: 1;
            margin-left: 10px;
        }

        .leaderboard-preview-score {
            font-weight: bold;
            color: #4ecdc4;
        }

        .leaderboard-preview-current {
            background: rgba(78, 205, 196, 0.1);
            border-radius: 4px;
            padding: 4px 8px;
        }

        .game-over-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .game-over-buttons .vscode-button {
            padding: 10px 20px;
            font-size: 14px;
        }

        .level-up {
            color: #4ec9b0;
            font-size: 18px;
            display: none;
            animation: levelUpAnimation 2s ease-in-out;
        }

        @keyframes levelUpAnimation {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .player-input {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        /* éš¾åº¦é€‰æ‹©ç•Œé¢æ ·å¼ */
        .difficulty-select {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .difficulty-cards {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .difficulty-card {
            background: #1e1e1e;
            border: 2px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            min-width: 180px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .difficulty-card:hover {
            border-color: #0e639c;
            transform: translateY(-2px);
        }

        .difficulty-card.selected {
            border-color: #0e639c;
            background: #0e639c20;
        }

        .difficulty-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .difficulty-name {
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .difficulty-description {
            font-size: 12px;
            color: #858585;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .difficulty-speed {
            font-size: 11px;
            color: #4ec9b0;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .difficulty-recommend {
            font-size: 10px;
            color: #ffd700;
            opacity: 0.8;
        }

        /* æ’è¡Œæ¦œéš¾åº¦æ ‡ç­¾æ ·å¼ */
        .difficulty-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #3e3e42;
            padding-bottom: 10px;
        }

        .difficulty-tab {
            padding: 8px 16px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            color: #858585;
        }

        .difficulty-tab:hover {
            background: #2d2d30;
            border-color: #0e639c;
            color: #ffffff;
        }

        .difficulty-tab.active {
            background: #0e639c;
            border-color: #0e639c;
            color: #ffffff;
        }

        .input-modal {
            background: #2d2d30;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            text-align: center;
            min-width: 300px;
        }

        .input-title {
            color: #cccccc;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .player-name-input {
            width: 100%;
            padding: 10px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            color: #cccccc;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .leaderboard {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d30;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1500;
            display: none;
        }

        .leaderboard-title {
            color: #4ec9b0;
            font-size: 18px;
            text-align: center;
            margin-bottom: 15px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #3e3e42;
            color: #cccccc;
            font-size: 14px;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            color: #ffd700;
            font-weight: bold;
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.3;
            transition: opacity 0.5s ease;
        }

        .explosion {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes explosionAnimation {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(3) rotate(360deg); opacity: 0; }
        }

        .food-animation {
            position: absolute;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes eatAnimation {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #4ec9b0;
            border-radius: 50%;
            pointer-events: none;
            animation: particleAnimation 0.6s ease-out forwards;
        }

        @keyframes particleAnimation {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; }
        }

        /* æ°”æ§½ç³»ç»Ÿæ ·å¼ */
        .energy-bar-container {
            margin-top: 15px;
            padding: 10px 15px;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 3px;
        }

        .energy-bar-label {
            color: #4ec9b0;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .energy-bar {
            width: 100%;
            height: 20px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ec9b0 0%, #4da6ff 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 9px;
        }

        .energy-cells {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            pointer-events: none;
        }

        .energy-cell {
            flex: 1;
            border-right: 1px solid #3e3e42;
            height: 100%;
        }

        .energy-cell:last-child {
            border-right: none;
        }

        .energy-cell.filled {
            background: rgba(78, 201, 176, 0.2);
        }

        .energy-cell.ready {
            background: rgba(77, 166, 255, 0.3);
            box-shadow: 0 0 10px rgba(77, 166, 255, 0.5);
        }

        .energy-skill {
            margin-top: 8px;
            text-align: center;
            animation: skillPulse 1s ease-in-out infinite;
        }

        .skill-key {
            background: #0e639c;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        .skill-text {
            color: #4ec9b0;
            font-size: 12px;
            font-weight: 600;
            margin-left: 5px;
        }

        @keyframes skillPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* å¸æ”¶ç‰¹æŠ€æ•ˆæœ */
        .absorption-effect {
            position: absolute;
            pointer-events: none;
            z-index: 500;
        }

        @keyframes absorptionAnimation {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(3) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(6) rotate(360deg);
                opacity: 0;
            }
        }

        .food-absorption {
            position: absolute;
            pointer-events: none;
            z-index: 600;
            transition: all 0.5s ease-out;
        }

        /* å‡çº§è¿›åº¦æ¡æ ·å¼ */
        .upgrade-bar-container {
            margin-top: 15px;
            padding: 10px 15px;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 3px;
        }

        .upgrade-bar-label {
            color: #ffd700;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upgrade-bar {
            width: 100%;
            height: 20px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .upgrade-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700 0%, #ffed4e 50%, #f39c12 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 9px;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .upgrade-progress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            pointer-events: none;
        }

        .upgrade-ready {
            margin-top: 8px;
            text-align: center;
            color: #ffd700;
            font-size: 12px;
            font-weight: 600;
            animation: upgradePulse 1s ease-in-out infinite;
        }

        @keyframes upgradePulse {
            0%, 100% {
                opacity: 0.8;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        /* å‡çº§ç‰¹æ•ˆ */
        .upgrade-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffd700;
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            z-index: 3000;
            pointer-events: none;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        @keyframes upgradeAnimation {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* æˆå°±é€šçŸ¥æ ·å¼ */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .achievement-icon {
            font-size: 40px;
            flex-shrink: 0;
        }

        .achievement-content {
            flex: 1;
        }

        .achievement-title {
            font-size: 14px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .achievement-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .achievement-description {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.3;
        }

        @keyframes achievementSlideIn {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes achievementSlideOut {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* çš®è‚¤è§£é”æç¤ºæ ·å¼ */
        .skin-unlock-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 6000;
        }

        .unlock-content {
            background: #2d2d30;
            padding: 40px;
            border-radius: 15px;
            border: 2px solid #ffd700;
            text-align: center;
            max-width: 400px;
            animation: unlockModalAnimation 0.5s ease-out;
        }

        @keyframes unlockModalAnimation {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .unlock-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .unlock-title {
            color: #ffd700;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .unlock-skin-name {
            color: #4ec9b0;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .unlock-description {
            color: #cccccc;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .unlock-stats {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .unlock-stats div {
            color: #858585;
            font-size: 14px;
            margin: 5px 0;
        }

        .unlock-stats span {
            color: #ffd700;
            font-weight: bold;
        }

        /* çš®è‚¤é€‰æ‹©å™¨æ ·å¼ */
        .skin-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            min-width: 600px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 2500;
            display: none;
        }

        .skin-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #3e3e42;
        }

        .skin-selector-title {
            color: #4ec9b0;
            font-size: 20px;
            font-weight: 600;
        }

        .skin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .skin-card {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skin-card:hover {
            border-color: #4ec9b0;
            transform: translateY(-2px);
        }

        .skin-card.selected {
            border-color: #ffd700;
            background: #2d2d30;
        }

        .skin-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skin-card.locked:hover {
            border-color: #3e3e42;
            transform: none;
        }

        .skin-preview {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .skin-name {
            color: #cccccc;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .skin-description {
            color: #858585;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .skin-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .skin-status.unlocked {
            background: #4ec9b0;
            color: white;
        }

        .skin-status.locked {
            background: #858585;
            color: #cccccc;
        }

        /* çš®è‚¤é€‰æ‹©æŒ‰é’® */
        .skin-button {
            margin-top: 10px;
            padding: 8px 15px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .skin-button:hover {
            background: #1177bb;
        }

        .skin-button:disabled {
            background: #858585;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="vscode-container">
        <div class="sidebar">
            <div class="sidebar-icon active">ğŸ</div>
            <div class="sidebar-icon">ğŸ“</div>
            <div class="sidebar-icon">ğŸ”</div>
            <div class="sidebar-icon">âš™ï¸</div>
        </div>

        <div class="main-content">
            <div class="title-bar">
                <div class="title-bar-item active">snake.js</div>
                <div class="title-bar-item">README.md</div>
                <div class="title-bar-item">package.json</div>
            </div>

            <div class="activity-bar">
                <span>ğŸ VSCode Snake Game</span>
                <span style="margin-left: auto; color: #858585;">UTF-8</span>
                <span style="color: #858585;">JavaScript</span>
            </div>

            <div class="editor-container">
                <div class="game-header">
                    <div class="game-title-container">
                        <div class="game-title">ğŸ VSCode Snake Game</div>
                        <div class="game-difficulty" id="gameDifficulty">âš–ï¸ æ ‡å‡†æ¨¡å¼</div>
                        <div class="player-title" id="playerTitle">ğŸŒ± è›‡å®å®</div>
                    </div>
                    <div class="game-stats">
                        <div class="stat-item">
                            <span class="stat-label">Player:</span>
                            <span class="stat-value" id="playerName">Guest</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Score:</span>
                            <span class="stat-value" id="score">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Level:</span>
                            <span class="stat-value" id="level">1</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Progress:</span>
                            <span class="stat-value"><span id="progress">0</span>/<span id="target">5</span></span>
                        </div>
                    </div>

                    <!-- æ°”æ§½ç³»ç»Ÿ -->
                    <div class="energy-bar-container">
                        <div class="energy-bar-label">âš¡ Energy</div>
                        <div class="energy-bar" id="energyBar">
                            <div class="energy-fill" id="energyFill"></div>
                            <div class="energy-cells" id="energyCells"></div>
                        </div>
                        <div class="energy-skill" id="energySkill" style="display: none;">
                            <span class="skill-key">X</span> <span class="skill-text">ABSORB</span>
                        </div>
                    </div>

                    <!-- 100åˆ†å‡çº§è¿›åº¦æ¡ -->
                    <div class="upgrade-bar-container">
                        <div class="upgrade-bar-label">ğŸ† Upgrade Progress</div>
                        <div class="upgrade-bar" id="upgradeBar">
                            <div class="upgrade-fill" id="upgradeFill"></div>
                            <div class="upgrade-progress" id="upgradeProgress">
                                <span id="upgradeCurrent">0</span> / <span id="upgradeTarget">100</span>
                            </div>
                        </div>
                        <div class="upgrade-ready" id="upgradeReady" style="display: none;">
                            ğŸ‰ READY TO UPGRADE! ğŸ‰
                        </div>
                    </div>
                </div>

                <div class="game-area">
                    <canvas id="gameCanvas" width="600" height="400"></canvas>
                    <div class="game-over" id="gameOver">
                        <div class="game-over-title">ğŸ® Game Over!</div>
                        <div class="game-over-stats">
                            <div class="final-score">
                                <div class="score-label">æœ€ç»ˆå¾—åˆ†</div>
                                <div class="score-value" id="finalScore">0</div>
                            </div>
                            <div class="final-level">
                                <div class="level-label">è¾¾åˆ°ç­‰çº§</div>
                                <div class="level-value" id="finalLevel">1</div>
                            </div>
                        </div>
                        <div class="game-over-leaderboard">
                            <div class="leaderboard-preview-title">ğŸ† æœ¬å±€æ’è¡Œ</div>
                            <div class="leaderboard-preview-list" id="gameOverLeaderboard"></div>
                        </div>
                        <div class="game-over-buttons">
                            <button class="vscode-button" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
                            <button class="vscode-button secondary" onclick="showFullLeaderboard()">æŸ¥çœ‹å®Œæ•´æ’è¡Œæ¦œ</button>
                        </div>
                    </div>
                    <div class="level-up" id="levelUp">
                        <div style="font-size: 24px; margin-bottom: 10px;">Level Up!</div>
                        <div style="font-size: 14px; color: #858585;">Great job!</div>
                    </div>
                </div>

                <!-- ç©å®¶è¾“å…¥ç•Œé¢ -->
                <div class="player-input" id="playerInput">
                    <div class="input-modal">
                        <div class="input-title">ğŸ VSCode Snake Game</div>
                        <input type="text" class="player-name-input" id="playerNameInput" placeholder="è¾“å…¥ä½ çš„ç©å®¶åç§°" maxlength="10">
                        <div class="button-group">
                            <button class="vscode-button" id="startWithNameBtn">å¼€å§‹æ¸¸æˆ</button>
                            <button class="vscode-button secondary" id="showLeaderboardBtn">æ’è¡Œæ¦œ</button>
                        </div>
                    </div>
                </div>
                <!-- éš¾åº¦é€‰æ‹©ç•Œé¢ -->
                <div class="difficulty-select" id="difficultySelect">
                    <div class="input-modal">
                        <div class="input-title">ğŸ¯ é€‰æ‹©éš¾åº¦</div>
                        <div class="difficulty-cards">
                            <div class="difficulty-card" data-difficulty="casual">
                                <div class="difficulty-icon">ğŸŒ±</div>
                                <div class="difficulty-name">ä¼‘é—²æ¨¡å¼</div>
                                <div class="difficulty-description">è½»æ¾æ„‰å¿«ï¼Œé€‚åˆæ–°æ‰‹</div>
                                <div class="difficulty-speed">è›‡é€Ÿï¼šæ…¢é€Ÿ</div>
                                <div class="difficulty-recommend">æ¨èï¼šæ–°æ‰‹ç©å®¶</div>
                            </div>
                            <div class="difficulty-card selected" data-difficulty="standard">
                                <div class="difficulty-icon">âš–ï¸</div>
                                <div class="difficulty-name">æ ‡å‡†æ¨¡å¼</div>
                                <div class="difficulty-description">å¹³è¡¡ä½“éªŒï¼ŒæŒ‘æˆ˜é€‚ä¸­</div>
                                <div class="difficulty-speed">è›‡é€Ÿï¼šæ­£å¸¸</div>
                                <div class="difficulty-recommend">æ¨èï¼šæ™®é€šç©å®¶</div>
                            </div>
                            <div class="difficulty-card" data-difficulty="extreme">
                                <div class="difficulty-icon">ğŸ”¥</div>
                                <div class="difficulty-name">æé™æ¨¡å¼</div>
                                <div class="difficulty-description">æé™æŒ‘æˆ˜ï¼Œååº”åŠ›è€ƒéªŒ</div>
                                <div class="difficulty-speed">è›‡é€Ÿï¼šæé€Ÿ</div>
                                <div class="difficulty-recommend">æ¨èï¼šç¡¬æ ¸ç©å®¶</div>
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="vscode-button" id="confirmDifficultyBtn">ç¡®è®¤éš¾åº¦</button>
                            <button class="vscode-button secondary" id="backToNameBtn">è¿”å›ä¸Šä¸€æ­¥</button>
                        </div>
                    </div>
                </div>

                <!-- æ’è¡Œæ¦œ -->
                <div class="leaderboard" id="leaderboard">
                    <div class="leaderboard-title">ğŸ† æ’è¡Œæ¦œ</div>
                    <div id="leaderboardList"></div>
                    <div class="button-group" style="margin-top: 15px;">
                        <button class="vscode-button secondary" id="closeLeaderboardBtn">å…³é—­</button>
                    </div>
                </div>

                <!-- èƒŒæ™¯å›¾ç‰‡ -->
                <img class="background-overlay" id="backgroundImage" src="" alt="background">

                <!-- çš®è‚¤è§£é”æç¤º -->
                <div class="skin-unlock-modal" id="skinUnlockModal">
                    <div class="unlock-content">
                        <div class="unlock-icon">ğŸ‰</div>
                        <div class="unlock-title">æ–°çš®è‚¤è§£é”!</div>
                        <div class="unlock-skin-name" id="unlockSkinName"></div>
                        <div class="unlock-description" id="unlockDescription"></div>
                        <div class="unlock-stats">
                            <div>æ–°çºªå½•: <span id="newRecordLevel"></span> çº§</div>
                            <div>è¶…è¶Š: <span id="previousRecord"></span> çº§</div>
                        </div>
                        <button class="vscode-button" onclick="closeSkinUnlock()">å¤ªæ£’äº†!</button>
                    </div>
                </div>

                <!-- çš®è‚¤é€‰æ‹©å™¨ -->
                <div class="skin-selector" id="skinSelector">
                    <div class="skin-selector-header">
                        <div class="skin-selector-title">ğŸ¨ é€‰æ‹©çš®è‚¤</div>
                        <button class="vscode-button secondary" onclick="closeSkinSelector()">å…³é—­</button>
                    </div>
                    <div class="skin-grid" id="skinGrid"></div>
                </div>

                <div class="controls">
                    <div class="control-title">Controls</div>
                    <div class="button-group">
                        <button class="vscode-button" id="startBtn">Start Game (F5)</button>
                        <button class="vscode-button secondary" id="pauseBtn">Pause (F6)</button>
                        <button class="vscode-button secondary" id="restartBtn">Restart (Ctrl+Shift+F5)</button>
                        <button class="vscode-button secondary" id="skinBtn" onclick="showSkinSelector()">ğŸ¨ Skins</button>
                    </div>
                    <div class="controls-info">
                        Use arrow keys to control the snake. Eat food to grow and level up!<br>
                        Different foods give different points. ğŸ Apple: 10pts | ğŸ§€ Cheese: 15pts | ğŸ¥’ Cucumber: 20pts | ğŸ‘© Beauty: 25pts<br>
                        <strong>Energy System:</strong> Eat 10 foods to fill energy bar, then press <strong>X</strong> to absorb all foods within 5 range!<br>
                        <strong>Upgrade Progress:</strong> Earn 100 points to trigger upgrade bonus and get extra rewards!<br>
                        <strong>Skin System:</strong> Break records to unlock new snake skins! Current best: <span id="bestLevel">5</span> levels
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const progressElement = document.getElementById('progress');
        const targetElement = document.getElementById('target');
        const playerNameElement = document.getElementById('playerName');
        const gameOverElement = document.getElementById('gameOver');
        const levelUpElement = document.getElementById('levelUp');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const restartBtn = document.getElementById('restartBtn');
        const gameArea = document.querySelector('.game-area');
        const playerInput = document.getElementById('playerInput');
        const playerNameInput = document.getElementById('playerNameInput');
        const startWithNameBtn = document.getElementById('startWithNameBtn');
        const showLeaderboardBtn = document.getElementById('showLeaderboardBtn');
        const leaderboard = document.getElementById('leaderboard');
        const leaderboardList = document.getElementById('leaderboardList');
        const closeLeaderboardBtn = document.getElementById('closeLeaderboardBtn');
        const backgroundImage = document.getElementById('backgroundImage');

        // éš¾åº¦ç³»ç»Ÿå…ƒç´ 
        const difficultySelect = document.getElementById('difficultySelect');
        const confirmDifficultyBtn = document.getElementById('confirmDifficultyBtn');
        const backToNameBtn = document.getElementById('backToNameBtn');

        // éš¾åº¦é…ç½®
        const difficultyConfig = {
            casual: {
                name: 'ä¼‘é—²æ¨¡å¼',
                icon: 'ğŸŒ±',
                gameSpeed: 200,
                color: '#4ec9b0'
            },
            standard: {
                name: 'æ ‡å‡†æ¨¡å¼',
                icon: 'âš–ï¸',
                gameSpeed: 150,
                color: '#0e639c'
            },
            extreme: {
                name: 'æé™æ¨¡å¼',
                icon: 'ğŸ”¥',
                gameSpeed: 100,
                color: '#ff6b6b'
            }
        };

        // å½“å‰æ¸¸æˆéš¾åº¦
        let currentDifficulty = 'standard';
        let tempPlayerName = '';

        // æ°”æ§½ç³»ç»Ÿå…ƒç´ 
        const energyBar = document.getElementById('energyBar');
        const energyFill = document.getElementById('energyFill');
        const energyCells = document.getElementById('energyCells');
        const energySkill = document.getElementById('energySkill');

        // å‡çº§è¿›åº¦æ¡å…ƒç´ 
        const upgradeBar = document.getElementById('upgradeBar');
        const upgradeFill = document.getElementById('upgradeFill');
        const upgradeProgress = document.getElementById('upgradeProgress');
        const upgradeCurrent = document.getElementById('upgradeCurrent');
        const upgradeTarget = document.getElementById('upgradeTarget');
        const upgradeReady = document.getElementById('upgradeReady');

        // æ¸¸æˆè®¾ç½®
        const gridSize = 20;
        const tileCountX = canvas.width / gridSize;
        const tileCountY = canvas.height / gridSize;

        let snake = [
            {x: 10, y: 10}
        ];
        let direction = {x: 0, y: 0};
        let foods = [];
        let bombs = []; // ç‚¸å¼¹æ•°ç»„
        let score = 0;
        let level = 1;
        let levelProgress = 0;
        let levelTarget = 5;
        let gameSpeed = 150;
        let gameRunning = false;
        let gamePaused = false;
        let snakeTrail = []; // è›‡çš„è½¨è¿¹ç”¨äºæ®‹å½±æ•ˆæœ
        let currentPlayer = 'Guest'; // å½“å‰ç©å®¶
        let gameStarted = false; // æ¸¸æˆæ˜¯å¦å¼€å§‹

        // æ°”æ§½ç³»ç»Ÿå˜é‡
        let energyLevel = 0; // å½“å‰èƒ½é‡ç­‰çº§ (0-10)
        let maxEnergy = 10; // æœ€å¤§èƒ½é‡å€¼
        let skillReady = false; // ç‰¹æŠ€æ˜¯å¦å°±ç»ª
        let isAbsorbing = false; // æ˜¯å¦æ­£åœ¨ä½¿ç”¨å¸æ”¶ç‰¹æŠ€

        // å‡çº§è¿›åº¦æ¡å˜é‡
        let upgradeScore = 0; // å½“å‰å‡çº§åˆ†æ•°
        let upgradeThreshold = 100; // å‡çº§æ‰€éœ€åˆ†æ•°
        let upgradeBonusCount = 0; // å‡çº§å¥–åŠ±æ¬¡æ•°

        // çš®è‚¤ç³»ç»Ÿå˜é‡
        let currentSkin = 'default';
        let skinUnlockModal = document.getElementById('skinUnlockModal');
        let skinSelector = document.getElementById('skinSelector');
        let newRecordLevel = document.getElementById('newRecordLevel');
        let previousRecord = document.getElementById('previousRecord');
        let unlockSkinName = document.getElementById('unlockSkinName');
        let unlockDescription = document.getElementById('unlockDescription');
        let bestLevelElement = document.getElementById('bestLevel');

        // èƒŒæ™¯å›¾ç‰‡æ•°ç»„ - ä¸åŒå…³å¡ä½¿ç”¨ä¸åŒçš„èƒŒæ™¯
        const backgroundImages = [
            'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=1920&h=1080&fit=crop',
            'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=1920&h=1080&fit=crop',
            'https://images.unsplash.com/photo-1518770660439-4636190af475?w=1920&h=1080&fit=crop',
            'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=1920&h=1080&fit=crop'
        ];

        // æ’è¡Œæ¦œæ•°æ®ï¼ˆåˆ†éš¾åº¦å­˜å‚¨ï¼‰
        let leaderboardData = {
            casual: JSON.parse(localStorage.getItem('snakeLeaderboard_casual')) || [],
            standard: JSON.parse(localStorage.getItem('snakeLeaderboard_standard')) || [],
            extreme: JSON.parse(localStorage.getItem('snakeLeaderboard_extreme')) || []
        };

        // å½“å‰æ˜¾ç¤ºçš„æ’è¡Œæ¦œéš¾åº¦
        let currentLeaderboardDifficulty = 'standard';

        // å†å²æœ€é«˜ç­‰çº§è®°å½•
        let historicalMaxLevel = parseInt(localStorage.getItem('snakeHistoricalMaxLevel') || '5');
        let unlockedSkins = JSON.parse(localStorage.getItem('snakeUnlockedSkins') || '[]');

        // çš®è‚¤ç³»ç»Ÿ
        const snakeSkins = [
            {
                id: 'default',
                name: 'Classic VSCode',
                description: 'é»˜è®¤ç»å…¸çš®è‚¤',
                unlocked: true,
                headColor: ['#4da6ff', '#007acc', '#005a9e'],
                bodyColor: ['rgba(120, 220, 200, ', 'rgba(78, 201, 176, ', 'rgba(40, 140, 120, '],
                logo: 'VS'
            },
            {
                id: 'fire',
                name: 'ç«ç„°è›‡',
                description: 'è¾¾åˆ°6çº§è§£é”',
                unlocked: false,
                headColor: ['#ff6b6b', '#ee5a52', '#dc2626'],
                bodyColor: ['rgba(255, 107, 107, ', 'rgba(238, 90, 82, ', 'rgba(220, 38, 38, '],
                logo: 'ğŸ”¥'
            },
            {
                id: 'ice',
                name: 'å†°éœœè›‡',
                description: 'è¾¾åˆ°8çº§è§£é”',
                unlocked: false,
                headColor: ['#74c0fc', '#339af0', '#1864ab'],
                bodyColor: ['rgba(116, 192, 252, ', 'rgba(51, 154, 240, ', 'rgba(24, 100, 171, '],
                logo: 'â„ï¸'
            },
            {
                id: 'nature',
                name: 'è‡ªç„¶è›‡',
                description: 'è¾¾åˆ°10çº§è§£é”',
                unlocked: false,
                headColor: ['#51cf66', '#40c057', '#2b8a3e'],
                bodyColor: ['rgba(81, 207, 102, ', 'rgba(64, 192, 87, ', 'rgba(43, 138, 62, '],
                logo: 'ğŸŒ¿'
            },
            {
                id: 'galaxy',
                name: 'æ˜Ÿæ²³è›‡',
                description: 'è¾¾åˆ°12çº§è§£é”',
                unlocked: false,
                headColor: ['#cc5de8', '#ae3ec9', '#9c36b5'],
                bodyColor: ['rgba(204, 93, 232, ', 'rgba(174, 62, 201, ', 'rgba(156, 54, 181, '],
                logo: 'ğŸŒŒ'
            },
            {
                id: 'rainbow',
                name: 'å½©è™¹è›‡',
                description: 'è¾¾åˆ°15çº§è§£é”',
                unlocked: false,
                headColor: ['#ff6b6b', '#4ec9b0', '#ffd700', '#a78bfa', '#fb7185'],
                bodyColor: ['rgba(255, 107, 107, ', 'rgba(78, 201, 176, ', 'rgba(255, 215, 0, ', 'rgba(167, 139, 250, ', 'rgba(251, 113, 133, '],
                logo: 'ğŸŒˆ'
            }
        ];

        // é£Ÿç‰©ç±»å‹å®šä¹‰
        const foodTypes = [
            {emoji: 'ğŸ', name: 'apple', points: 10, color: '#ff0000'},
            {emoji: 'ğŸ§€', name: 'cheese', points: 15, color: '#ffd700'},
            {emoji: 'ğŸ¥’', name: 'cucumber', points: 20, color: '#00ff00'},
            {emoji: 'ğŸ‘©', name: 'beauty', points: 25, color: '#ff69b4'}
        ];

        // ä¸åŒç­‰çº§çš„è›‡çš„å¤–è§‚é…ç½®
        const snakeStyles = [
            // Level 1-2: åŸºç¡€è“è‰²
            {
                headColor: ['#4da6ff', '#007acc', '#005a9e'],
                bodyColor: ['rgba(120, 220, 200, ', 'rgba(78, 201, 176, ', 'rgba(40, 140, 120, '],
                logo: 'VS',
                eyeColor: '#ffffff'
            },
            // Level 3-4: ç´«è‰²ç³»
            {
                headColor: ['#b794f4', '#9f7aea', '#805ad5'],
                bodyColor: ['rgba(196, 181, 253, ', 'rgba(167, 139, 250, ', 'rgba(139, 92, 246, '],
                logo: 'VS',
                eyeColor: '#e9d8fd'
            },
            // Level 5-6: é‡‘è‰²ç³»
            {
                headColor: ['#ffd700', '#ffb347', '#ff8c00'],
                bodyColor: ['rgba(255, 223, 0, ', 'rgba(255, 179, 71, ', 'rgba(255, 140, 0, '],
                logo: 'â­',
                eyeColor: '#fff5b4'
            },
            // Level 7-8: çº¢å®çŸ³ç³»
            {
                headColor: ['#ff6b6b', '#ee5a52', '#dc2626'],
                bodyColor: ['rgba(255, 107, 107, ', 'rgba(238, 90, 82, ', 'rgba(220, 38, 38, '],
                logo: 'ğŸ’',
                eyeColor: '#fecaca'
            },
            // Level 9+: å½©è™¹ç³»
            {
                headColor: ['#ff6b6b', '#4ec9b0', '#ffd700', '#a78bfa', '#fb7185'],
                bodyColor: ['rgba(255, 107, 107, ', 'rgba(78, 201, 176, ', 'rgba(255, 215, 0, ', 'rgba(167, 139, 250, ', 'rgba(251, 113, 133, '],
                logo: 'ğŸ‘‘',
                eyeColor: '#ffffff'
            }
        ];

        // ç‚¸å¼¹ç±»å‹å®šä¹‰
        const bombTypes = [
            {emoji: 'ğŸ’£', name: 'bomb', points: -15, color: '#8B4513'},
            {emoji: 'ğŸ”¥', name: 'fire', points: -20, color: '#FF4500'},
            {emoji: 'âš¡', name: 'lightning', points: -25, color: '#FFD700'}
        ];

        // ç”Ÿæˆå•ä¸ªé£Ÿç‰©
        function generateSingleFood() {
            let newFood;
            let attempts = 0;
            const maxAttempts = 100;

            do {
                newFood = {
                    x: Math.floor(Math.random() * tileCountX),
                    y: Math.floor(Math.random() * tileCountY),
                    type: foodTypes[Math.floor(Math.random() * foodTypes.length)]
                };
                attempts++;
            } while (attempts < maxAttempts && isPositionOccupied(newFood.x, newFood.y));

            return newFood;
        }

        // ç”Ÿæˆå•ä¸ªç‚¸å¼¹
        function generateSingleBomb() {
            let newBomb;
            let attempts = 0;
            const maxAttempts = 100;

            do {
                newBomb = {
                    x: Math.floor(Math.random() * tileCountX),
                    y: Math.floor(Math.random() * tileCountY),
                    type: bombTypes[Math.floor(Math.random() * bombTypes.length)]
                };
                attempts++;
            } while (attempts < maxAttempts && isPositionOccupied(newBomb.x, newBomb.y));

            return newBomb;
        }

        // æ£€æŸ¥ä½ç½®æ˜¯å¦è¢«å ç”¨
        function isPositionOccupied(x, y) {
            for (let segment of snake) {
                if (segment.x === x && segment.y === y) {
                    return true;
                }
            }
            for (let food of foods) {
                if (food.x === x && food.y === y) {
                    return true;
                }
            }
            for (let bomb of bombs) {
                if (bomb.x === x && bomb.y === y) {
                    return true;
                }
            }
            return false;
        }

        // ç”Ÿæˆå¤šä¸ªé£Ÿç‰©
        function generateFoods() {
            foods = [];
            const foodCount = Math.min(2 + Math.floor(level / 2), 6);

            for (let i = 0; i < foodCount; i++) {
                const food = generateSingleFood();
                if (food) {
                    foods.push(food);
                }
            }
        }

        // ç”Ÿæˆç‚¸å¼¹
        function generateBombs() {
            bombs = [];
            const bombCount = Math.min(1 + Math.floor(level / 3), 3);

            for (let i = 0; i < bombCount; i++) {
                const bomb = generateSingleBomb();
                if (bomb) {
                    bombs.push(bomb);
                }
            }
        }

        // åˆ›å»ºç²’å­æ•ˆæœ
        function createParticles(x, y, color, count = 8) {
            const rect = canvas.getBoundingClientRect();
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = (rect.left + x * gridSize + gridSize/2) + 'px';
                particle.style.top = (rect.top + y * gridSize + gridSize/2) + 'px';
                particle.style.background = color;

                const angle = (i / count) * Math.PI * 2;
                const distance = 50;
                particle.style.setProperty('--dx', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--dy', Math.sin(angle) * distance + 'px');

                gameArea.appendChild(particle);

                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 600);
            }
        }

        // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
        function createExplosion(x, y, color) {
            const rect = canvas.getBoundingClientRect();
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = (rect.left + x * gridSize + gridSize/2) + 'px';
            explosion.style.top = (rect.top + y * gridSize + gridSize/2) + 'px';
            explosion.style.width = gridSize + 'px';
            explosion.style.height = gridSize + 'px';
            explosion.style.background = color;
            explosion.style.borderRadius = '50%';
            explosion.style.animation = 'explosionAnimation 0.8s ease-out forwards';

            gameArea.appendChild(explosion);

            // åˆ›å»ºçˆ†ç‚¸ç²’å­
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = (rect.left + x * gridSize + gridSize/2) + 'px';
                particle.style.top = (rect.top + y * gridSize + gridSize/2) + 'px';
                particle.style.background = color;

                const angle = (i / 12) * Math.PI * 2;
                const distance = 80;
                particle.style.setProperty('--dx', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--dy', Math.sin(angle) * distance + 'px');

                gameArea.appendChild(particle);

                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 800);
            }

            setTimeout(() => {
                if (explosion.parentNode) {
                    explosion.parentNode.removeChild(explosion);
                }
            }, 800);
        }

        // ç»˜åˆ¶å¸¦æ®‹å½±çš„è›‡
        function drawSnake() {
            // æ›´æ–°è½¨è¿¹
            snakeTrail.push([...snake]);
            if (snakeTrail.length > 8) {
                snakeTrail.shift();
            }

            // ç»˜åˆ¶æ®‹å½±
            for (let t = 0; t < snakeTrail.length - 1; t++) {
                const trailSnake = snakeTrail[t];
                const opacity = (t + 1) / snakeTrail.length * 0.3;

                for (let i = 0; i < trailSnake.length; i++) {
                    const segment = trailSnake[i];
                    const x = segment.x * gridSize;
                    const y = segment.y * gridSize;
                    const centerX = x + gridSize / 2;
                    const centerY = y + gridSize / 2;

                    // å°¾éƒ¨é€æ¸å˜ç»†
                    const sizeRatio = Math.max(0.3, 1 - i * 0.1);
                    const radius = (gridSize / 2 - 1) * sizeRatio * (0.7 + opacity * 0.3);

                    ctx.globalAlpha = opacity;
                    ctx.fillStyle = '#4ec9b0';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            ctx.globalAlpha = 1;

            // ç»˜åˆ¶ä¸»è›‡
            for (let i = 0; i < snake.length; i++) {
                const segment = snake[i];
                const x = segment.x * gridSize;
                const y = segment.y * gridSize;
                const centerX = x + gridSize / 2;
                const centerY = y + gridSize / 2;

                if (i === 0) {
                    // è›‡å¤´ - VSCodeé£æ ¼
                    drawVSCodeSnakeHead(x, y, centerX, centerY);
                } else {
                    // è›‡èº« - é€æ¸å˜ç»†
                    drawVSCodeSnakeBody(x, y, centerX, centerY, i);
                }
            }
        }

        // ç»˜åˆ¶VSCodeé£æ ¼çš„è›‡å¤´
        function drawVSCodeSnakeHead(x, y, centerX, centerY) {
            // è·å–å½“å‰é€‰ä¸­çš„çš®è‚¤
            const currentSkinData = snakeSkins.find(skin => skin.id === currentSkin) || snakeSkins[0];

            // 3Då¤´éƒ¨ä¸»ä½“ - å¤šå±‚åœ†å½¢åˆ›å»ºç«‹ä½“æ„Ÿ
            const gradient = ctx.createRadialGradient(centerX - 2, centerY - 2, 0, centerX, centerY, gridSize / 2);

            if (currentSkinData.headColor.length === 3) {
                // æ™®é€šæ¸å˜
                gradient.addColorStop(0, currentSkinData.headColor[0]);
                gradient.addColorStop(0.7, currentSkinData.headColor[1]);
                gradient.addColorStop(1, currentSkinData.headColor[2]);
            } else {
                // å½©è™¹æ¸å˜
                for (let i = 0; i < currentSkinData.headColor.length; i++) {
                    gradient.addColorStop(i / (currentSkinData.headColor.length - 1), currentSkinData.headColor[i]);
                }
            }

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(centerX, centerY, gridSize / 2 - 1, 0, Math.PI * 2);
            ctx.fill();

            // 3Dé«˜å…‰æ•ˆæœ
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.beginPath();
            ctx.arc(centerX - 3, centerY - 3, gridSize / 4, 0, Math.PI * 2);
            ctx.fill();

            // Logoæ•ˆæœ
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(currentSkinData.logo, centerX, centerY);

            // 3Dçœ¼ç›æ•ˆæœ
            const eyeSize = 3;
            let leftEyeX = centerX - 4;
            let leftEyeY = centerY - 3;
            let rightEyeX = centerX + 4;
            let rightEyeY = centerY - 3;

            if (direction.x === 1) { leftEyeX += 2; rightEyeX += 2; }
            else if (direction.x === -1) { leftEyeX -= 2; rightEyeX -= 2; }
            else if (direction.y === -1) { leftEyeY -= 2; rightEyeY -= 2; }
            else if (direction.y === 1) { leftEyeY += 2; rightEyeY += 2; }

            // çœ¼ç™½3Dæ•ˆæœ
            const eyeGradient = ctx.createRadialGradient(leftEyeX - 1, leftEyeY - 1, 0, leftEyeX, leftEyeY, eyeSize);
            eyeGradient.addColorStop(0, '#ffffff');
            eyeGradient.addColorStop(1, '#e0e0e0');

            ctx.fillStyle = eyeGradient;
            ctx.beginPath();
            ctx.arc(leftEyeX, leftEyeY, eyeSize, 0, Math.PI * 2);
            ctx.arc(rightEyeX, rightEyeY, eyeSize, 0, Math.PI * 2);
            ctx.fill();

            // çœ¼ç 3Dæ•ˆæœ
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(leftEyeX + 1, leftEyeY + 1, 1.5, 0, Math.PI * 2);
            ctx.arc(rightEyeX + 1, rightEyeY + 1, 1.5, 0, Math.PI * 2);
            ctx.fill();

            // çœ¼ç›é«˜å…‰
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(leftEyeX + 2, leftEyeY, 0.8, 0, Math.PI * 2);
            ctx.arc(rightEyeX + 2, rightEyeY, 0.8, 0, Math.PI * 2);
            ctx.fill();
        }

        // ç»˜åˆ¶VSCodeé£æ ¼çš„è›‡èº«
        function drawVSCodeSnakeBody(x, y, centerX, centerY, index) {
            // è·å–å½“å‰é€‰ä¸­çš„çš®è‚¤
            const currentSkinData = snakeSkins.find(skin => skin.id === currentSkin) || snakeSkins[0];

            // é€æ¸å˜ç»†æ•ˆæœ
            const sizeRatio = Math.max(0.5, 1 - index * 0.05);
            const radius = (gridSize / 2 - 2) * sizeRatio;

            // æ¸å˜é¢œè‰²å’Œ3Dæ•ˆæœ
            const intensity = Math.max(0.3, 1 - index * 0.1);

            // 3Då¾„å‘æ¸å˜
            const gradient = ctx.createRadialGradient(
                centerX - radius * 0.3, centerY - radius * 0.3, 0,
                centerX, centerY, radius
            );

            if (currentSkinData.bodyColor.length === 3) {
                // æ™®é€šæ¸å˜
                gradient.addColorStop(0, currentSkinData.bodyColor[0] + intensity + ')');
                gradient.addColorStop(0.6, currentSkinData.bodyColor[1] + intensity + ')');
                gradient.addColorStop(1, currentSkinData.bodyColor[2] + intensity + ')');
            } else {
                // å½©è™¹æ¸å˜ - æ ¹æ®è›‡èº«ä½ç½®é€‰æ‹©é¢œè‰²
                const colorIndex = index % currentSkinData.bodyColor.length;
                const baseColor = currentSkinData.bodyColor[colorIndex];
                gradient.addColorStop(0, baseColor + intensity + ')');
                gradient.addColorStop(0.6, baseColor + (intensity * 0.8) + ')');
                gradient.addColorStop(1, baseColor + (intensity * 0.6) + ')');
            }

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.fill();

            // 3Dé«˜å…‰æ•ˆæœ
            ctx.fillStyle = `rgba(255, 255, 255, ${intensity * 0.3})`;
            ctx.beginPath();
            ctx.arc(centerX - radius * 0.3, centerY - radius * 0.3, radius * 0.4, 0, Math.PI * 2);
            ctx.fill();

            // è¾¹æ¡† - æ ¹æ®çš®è‚¤è°ƒæ•´é¢œè‰²
            const borderIntensity = Math.max(0.2, intensity * 0.8);
            ctx.strokeStyle = currentSkinData.bodyColor[0] + borderIntensity + ')';
            ctx.lineWidth = 1;
            ctx.stroke();

            // 3Dé˜´å½±æ•ˆæœ
            ctx.strokeStyle = `rgba(0, 0, 0, ${intensity * 0.3})`;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(centerX + 1, centerY + 1, radius, 0, Math.PI * 2);
            ctx.stroke();
        }

        // ç»˜åˆ¶é£Ÿç‰©
        function drawFood() {
            for (let i = 0; i < foods.length; i++) {
                const food = foods[i];
                const x = food.x * gridSize;
                const y = food.y * gridSize;
                const centerX = x + gridSize / 2;
                const centerY = y + gridSize / 2;

                // ç»˜åˆ¶é£Ÿç‰©èƒŒæ™¯
                ctx.fillStyle = food.type.color;
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.arc(centerX, centerY, gridSize / 2 - 1, 0, Math.PI * 2);
                ctx.fill();

                // ç»˜åˆ¶emoji
                ctx.globalAlpha = 1;
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(food.type.emoji, centerX, centerY);

                // åˆ†æ•°æ ‡ç­¾
                ctx.fillStyle = '#4ec9b0';
                ctx.font = '10px Arial';
                ctx.fillText(food.type.points, centerX, centerY + 12);
            }
        }

        // ç»˜åˆ¶ç‚¸å¼¹
        function drawBombs() {
            for (let i = 0; i < bombs.length; i++) {
                const bomb = bombs[i];
                const x = bomb.x * gridSize;
                const y = bomb.y * gridSize;
                const centerX = x + gridSize / 2;
                const centerY = y + gridSize / 2;

                // ç‚¸å¼¹è„‰å†²æ•ˆæœ
                const pulse = Math.sin(Date.now() * 0.005) * 0.2 + 0.8;

                // ç»˜åˆ¶ç‚¸å¼¹èƒŒæ™¯
                ctx.fillStyle = bomb.type.color;
                ctx.globalAlpha = 0.3 * pulse;
                ctx.beginPath();
                ctx.arc(centerX, centerY, (gridSize / 2 - 1) * pulse, 0, Math.PI * 2);
                ctx.fill();

                // ç»˜åˆ¶emoji
                ctx.globalAlpha = 1;
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(bomb.type.emoji, centerX, centerY);

                // åˆ†æ•°æ ‡ç­¾
                ctx.fillStyle = '#ff6b6b';
                ctx.font = '10px Arial';
                ctx.fillText(bomb.type.points, centerX, centerY + 12);
            }
        }

        // ç»˜åˆ¶æ¸¸æˆ
        function draw() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#1e1e1e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#2d2d30';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= tileCountX; i++) {
                ctx.beginPath();
                ctx.moveTo(i * gridSize, 0);
                ctx.lineTo(i * gridSize, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i <= tileCountY; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * gridSize);
                ctx.lineTo(canvas.width, i * gridSize);
                ctx.stroke();
            }

            drawSnake();
            drawFood();
            drawBombs();
        }

        // ç§»åŠ¨è›‡
        function moveSnake() {
            const head = {x: snake[0].x + direction.x, y: snake[0].y + direction.y};

            // æ£€æŸ¥ç¢°æ’å¢™å£
            if (head.x < 0 || head.x >= tileCountX || head.y < 0 || head.y >= tileCountY) {
                gameOver();
                return;
            }

            // æ£€æŸ¥ç¢°æ’è‡ªå·±
            for (let segment of snake) {
                if (head.x === segment.x && head.y === segment.y) {
                    gameOver();
                    return;
                }
            }

            snake.unshift(head);

            // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
            let foodEaten = false;
            for (let i = foods.length - 1; i >= 0; i--) {
                if (head.x === foods[i].x && head.y === foods[i].y) {
                    const food = foods[i];
                    score += food.type.points * level;
                    levelProgress++;
                    scoreElement.textContent = score;
                    progressElement.textContent = levelProgress;

                    // å¢åŠ èƒ½é‡
                    addEnergy(1);

                    // å¢åŠ å‡çº§åˆ†æ•°
                    addUpgradeScore(food.type.points);

                    // åˆ›å»ºç²’å­æ•ˆæœ
                    createParticles(food.x, food.y, food.type.color);

                    // ç§»é™¤è¢«åƒæ‰çš„é£Ÿç‰©
                    foods.splice(i, 1);
                    foodEaten = true;

                    // æ›´æ–°æ¸¸æˆç»Ÿè®¡æ•°æ®
                    gameStats.totalFoodsEaten++;

                    // æ£€æŸ¥æˆå°±è§£é”
                    checkAchievements();

                    if (levelProgress >= levelTarget) {
                        levelUp();
                    }
                    break;
                }
            }

            // æ£€æŸ¥æ˜¯å¦ç¢°åˆ°ç‚¸å¼¹
            let bombHit = false;
            for (let i = bombs.length - 1; i >= 0; i--) {
                if (head.x === bombs[i].x && head.y === bombs[i].y) {
                    const bomb = bombs[i];
                    score = Math.max(0, score + bomb.type.points);
                    scoreElement.textContent = score;

                    // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
                    createExplosion(bomb.x, bomb.y, bomb.type.color);

                    // ç§»é™¤ç‚¸å¼¹
                    bombs.splice(i, 1);
                    bombHit = true;

                    // æ›´æ–°æ¸¸æˆç»Ÿè®¡æ•°æ®
                    gameStats.bombsHit++;

                    // æ£€æŸ¥æˆå°±è§£é”
                    checkAchievements();
                    break;
                }
            }

            if (!foodEaten && !bombHit) {
                snake.pop();
            }

            // è¡¥å……é£Ÿç‰©
            if (foods.length < Math.min(2 + Math.floor(level / 2), 6)) {
                const newFood = generateSingleFood();
                if (newFood) {
                    foods.push(newFood);
                }
            }

            // è¡¥å……ç‚¸å¼¹
            if (bombs.length < Math.min(1 + Math.floor(level / 3), 3)) {
                const newBomb = generateSingleBomb();
                if (newBomb) {
                    bombs.push(newBomb);
                }
            }
        }

        // å…³å¡æå‡
        function levelUp() {
            const previousLevel = level;
            level++;
            levelProgress = 0;
            levelTarget = 5 + level * 2;

            // æ ¹æ®éš¾åº¦å’Œç­‰çº§è°ƒæ•´æ¸¸æˆé€Ÿåº¦
            const baseSpeed = difficultyConfig[currentDifficulty].gameSpeed;
            gameSpeed = Math.max(baseSpeed * 0.5, baseSpeed - level * 5);

            levelElement.textContent = level;
            progressElement.textContent = levelProgress;
            targetElement.textContent = levelTarget;

            // æ›´æ¢èƒŒæ™¯å›¾ç‰‡
            const bgIndex = (level - 1) % backgroundImages.length;
            backgroundImage.src = backgroundImages[bgIndex];
            backgroundImage.style.opacity = '0.4';

            // æ›´æ–°ç©å®¶ç§°å·
            updatePlayerTitle(level);

            // æ£€æŸ¥æˆå°±è§£é”
            checkAchievements();

            // æ£€æŸ¥æ˜¯å¦çªç ´å†å²æœ€é«˜ç­‰çº§
            let newRecord = false;
            if (level > historicalMaxLevel) {
                newRecord = true;
                const previousMaxLevel = historicalMaxLevel;
                historicalMaxLevel = level;
                localStorage.setItem('snakeHistoricalMaxLevel', historicalMaxLevel);
                bestLevelElement.textContent = historicalMaxLevel;

                // æ£€æŸ¥çš®è‚¤è§£é”
                const newlyUnlocked = checkSkinUnlocks(level);
                if (newlyUnlocked.length > 0) {
                    // å¦‚æœæœ‰æ–°çš®è‚¤è§£é”ï¼Œæš‚åœæ¸¸æˆ
                    gamePaused = true;
                    if (pauseBtn) {
                        pauseBtn.textContent = 'Continue (F6)';
                    }
                }
            }

            // æ˜¾ç¤ºå‡çº§ä¿¡æ¯
            if (newRecord) {
                levelUpElement.innerHTML = `
                    <div style="font-size: 28px; margin-bottom: 10px;">ğŸ‰ LEVEL UP! ğŸ‰</div>
                    <div style="font-size: 16px; color: #ffd700;">NEW RECORD! Level ${level}</div>
                    <div style="font-size: 14px; color: #858585;">Previous: Level ${previousLevel}</div>
                `;
            } else {
                levelUpElement.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">Level Up!</div>
                    <div style="font-size: 14px; color: #858585;">Level ${level}</div>
                `;
            }

            levelUpElement.style.display = 'block';
            setTimeout(() => {
                levelUpElement.style.display = 'none';
            }, 2000);

            generateFoods();
            generateBombs();
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameRunning = false;

            // æ˜¾ç¤ºæœ€ç»ˆå¾—åˆ†å’Œç­‰çº§
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalLevel').textContent = level;

            // ä¿å­˜åˆ°æ’è¡Œæ¦œ
            if (currentPlayer !== 'Guest' && score > 0) {
                addToLeaderboard(currentPlayer, score);
            }

            // æ˜¾ç¤ºæ¸¸æˆç»“æŸæ’è¡Œæ¦œ
            showGameOverLeaderboard();

            // ç¡®ä¿æ¸¸æˆç»“æŸç•Œé¢æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚
            gameOverElement.style.display = 'block';
            gameOverElement.style.zIndex = '5000';

            // è°ƒè¯•ä¿¡æ¯
            console.log('Game Over - Score:', score, 'Level:', level);
            console.log('Game Over element display:', gameOverElement.style.display);
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            if (!gameRunning || gamePaused) return;

            moveSnake();
            draw();

            setTimeout(gameLoop, gameSpeed);
        }

        // æ·»åŠ åˆ°æ’è¡Œæ¦œ
        function addToLeaderboard(name, score) {
            const entry = {
                name: name,
                score: score,
                level: level,
                difficulty: currentDifficulty,
                difficultyName: difficultyConfig[currentDifficulty].name,
                date: new Date().toLocaleDateString()
            };

            // æ·»åŠ åˆ°å¯¹åº”éš¾åº¦çš„æ’è¡Œæ¦œ
            leaderboardData[currentDifficulty].push(entry);
            leaderboardData[currentDifficulty].sort((a, b) => b.score - a.score);
            leaderboardData[currentDifficulty] = leaderboardData[currentDifficulty].slice(0, 10); // åªä¿ç•™å‰10å

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem(`snakeLeaderboard_${currentDifficulty}`, JSON.stringify(leaderboardData[currentDifficulty]));
        }

        // æ˜¾ç¤ºæ’è¡Œæ¦œ
        function showLeaderboard() {
            // åˆ›å»ºéš¾åº¦åˆ‡æ¢æ ‡ç­¾
            const difficultyTabs = document.createElement('div');
            difficultyTabs.className = 'difficulty-tabs';
            difficultyTabs.innerHTML = `
                <div class="difficulty-tab ${currentLeaderboardDifficulty === 'casual' ? 'active' : ''}" data-difficulty="casual">
                    ğŸŒ± ä¼‘é—²æ¨¡å¼
                </div>
                <div class="difficulty-tab ${currentLeaderboardDifficulty === 'standard' ? 'active' : ''}" data-difficulty="standard">
                    âš–ï¸ æ ‡å‡†æ¨¡å¼
                </div>
                <div class="difficulty-tab ${currentLeaderboardDifficulty === 'extreme' ? 'active' : ''}" data-difficulty="extreme">
                    ğŸ”¥ æé™æ¨¡å¼
                </div>
            `;

            // ç»‘å®šæ ‡ç­¾ç‚¹å‡»äº‹ä»¶
            difficultyTabs.querySelectorAll('.difficulty-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentLeaderboardDifficulty = tab.dataset.difficulty;
                    showLeaderboard(); // é‡æ–°æ˜¾ç¤ºæ’è¡Œæ¦œ
                });
            });

            leaderboardList.innerHTML = '';
            leaderboardList.appendChild(difficultyTabs);

            const currentData = leaderboardData[currentLeaderboardDifficulty];

            if (currentData.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.cssText = 'text-align: center; color: #858585; padding: 20px;';
                emptyDiv.textContent = 'æš‚æ— è®°å½•';
                leaderboardList.appendChild(emptyDiv);
            } else {
                currentData.forEach((entry, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';

                    let rankText = `#${index + 1}`;
                    if (index === 0) rankText = 'ğŸ¥‡ ' + rankText;
                    else if (index === 1) rankText = 'ğŸ¥ˆ ' + rankText;
                    else if (index === 2) rankText = 'ğŸ¥‰ ' + rankText;

                    item.innerHTML = `
                        <div>
                            <span class="rank">${rankText}</span>
                            <span>${entry.name}</span>
                        </div>
                        <div>
                            <span>${entry.score}åˆ†</span>
                            <span style="color: #858585; margin-left: 10px;">Lv.${entry.level}</span>
                            <span style="margin-left: 10px;">${difficultyConfig[entry.difficulty || 'standard'].icon}</span>
                        </div>
                    `;
                    leaderboardList.appendChild(item);
                });
            }

            leaderboard.style.display = 'block';
        }

        // éšè—æ’è¡Œæ¦œ
        function hideLeaderboard() {
            leaderboard.style.display = 'none';
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            snake = [{x: 10, y: 10}];
            direction = {x: 1, y: 0};
            foods = [];
            bombs = [];
            score = 0;
            level = 1;
            levelProgress = 0;
            levelTarget = 5;

            // æ ¹æ®éš¾åº¦è®¾ç½®æ¸¸æˆé€Ÿåº¦
            gameSpeed = difficultyConfig[currentDifficulty].gameSpeed;
            snakeTrail = [];

            // é‡ç½®æ°”æ§½ç³»ç»Ÿ
            energyLevel = 0;
            skillReady = false;
            isAbsorbing = false;
            updateEnergyDisplay();

            // é‡ç½®æ¸¸æˆç»Ÿè®¡æ•°æ®
            resetGameStats();

            // æ›´æ–°åˆå§‹ç§°å·
            updatePlayerTitle(level);

            // é‡ç½®å‡çº§è¿›åº¦æ¡
            upgradeScore = 0;
            upgradeBonusCount = 0;
            updateUpgradeDisplay();

            scoreElement.textContent = score;
            levelElement.textContent = level;
            progressElement.textContent = levelProgress;
            targetElement.textContent = levelTarget;
            gameRunning = true;
            gamePaused = false;
            gameOverElement.style.display = 'none';

            // éšè—æ’è¡Œæ¦œ
            leaderboard.style.display = 'none';

            generateFoods();
            generateBombs();
            draw();

            setTimeout(() => {
                if (gameRunning) {
                    gameLoop();
                }
            }, 500);
        }

        // æš‚åœ/ç»§ç»­æ¸¸æˆ
        function togglePause() {
            if (!gameRunning) return;

            gamePaused = !gamePaused;
            pauseBtn.textContent = gamePaused ? 'Continue (F6)' : 'Pause (F6)';

            if (!gamePaused) {
                gameLoop();
            }
        }

        // å¼€å§‹å¸¦åç§°çš„æ¸¸æˆ
        function startWithName() {
            const name = playerNameInput.value.trim();
            if (name) {
                tempPlayerName = name;
                playerInput.style.display = 'none';
                difficultySelect.style.display = 'flex';
            } else {
                alert('è¯·è¾“å…¥ç©å®¶åç§°ï¼');
            }
        }

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (!gameStarted) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    startWithName();
                }
                return;
            }

            if (!gameRunning || gamePaused) {
                if (e.key === 'F5') {
                    e.preventDefault();
                    startGame();
                }
                return;
            }

            // ç‰¹æŠ€è§¦å‘
            if (e.key === 'x' || e.key === 'X') {
                e.preventDefault();
                useSkill();
                return;
            }

            switch(e.key) {
                case 'ArrowUp':
                    if (direction.y === 0) {
                        direction = {x: 0, y: -1};
                    }
                    break;
                case 'ArrowDown':
                    if (direction.y === 0) {
                        direction = {x: 0, y: 1};
                    }
                    break;
                case 'ArrowLeft':
                    if (direction.x === 0) {
                        direction = {x: -1, y: 0};
                    }
                    break;
                case 'ArrowRight':
                    if (direction.x === 0) {
                        direction = {x: 1, y: 0};
                    }
                    break;
                case 'F5':
                    e.preventDefault();
                    startGame();
                    break;
                case 'F6':
                    e.preventDefault();
                    togglePause();
                    break;
            }
        });

        // æŒ‰é’®äº‹ä»¶
        startBtn.addEventListener('click', () => {
            if (!gameStarted) {
                playerInput.style.display = 'flex';
            } else {
                startGame();
            }
        });
        pauseBtn.addEventListener('click', togglePause);
        restartBtn.addEventListener('click', restartGame);
        startWithNameBtn.addEventListener('click', startWithName);
        showLeaderboardBtn.addEventListener('click', showLeaderboard);
        closeLeaderboardBtn.addEventListener('click', hideLeaderboard);

        // ç©å®¶åç§°è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        playerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                startWithName();
            }
        });

        // åˆå§‹åŒ–æ°”æ§½UI
        function initEnergyBar() {
            // åˆ›å»º10ä¸ªèƒ½é‡æ ¼å­
            energyCells.innerHTML = '';
            for (let i = 0; i < maxEnergy; i++) {
                const cell = document.createElement('div');
                cell.className = 'energy-cell';
                cell.id = `energy-cell-${i}`;
                energyCells.appendChild(cell);
            }
            updateEnergyDisplay();
        }

        // æ›´æ–°èƒ½é‡æ˜¾ç¤º
        function updateEnergyDisplay() {
            const fillPercentage = (energyLevel / maxEnergy) * 100;
            energyFill.style.width = fillPercentage + '%';

            // æ›´æ–°æ¯ä¸ªæ ¼å­çš„çŠ¶æ€
            for (let i = 0; i < maxEnergy; i++) {
                const cell = document.getElementById(`energy-cell-${i}`);
                cell.className = 'energy-cell';
                if (i < energyLevel) {
                    cell.classList.add('filled');
                    if (energyLevel === maxEnergy) {
                        cell.classList.add('ready');
                    }
                }
            }

            // æ˜¾ç¤º/éšè—ç‰¹æŠ€æç¤º
            if (energyLevel === maxEnergy && !isAbsorbing) {
                energySkill.style.display = 'block';
                skillReady = true;
            } else {
                energySkill.style.display = 'none';
                skillReady = false;
            }
        }

        // å¢åŠ èƒ½é‡
        function addEnergy(amount) {
            if (!isAbsorbing) {
                energyLevel = Math.min(energyLevel + amount, maxEnergy);
                updateEnergyDisplay();
            }
        }

        // ä½¿ç”¨ç‰¹æŠ€
        function useSkill() {
            if (skillReady && !isAbsorbing) {
                performAbsorption();
            }
        }

        // æ‰§è¡Œå¸æ”¶ç‰¹æŠ€
        function performAbsorption() {
            isAbsorbing = true;
            skillReady = false;
            energySkill.style.display = 'none';

            // æ›´æ–°æ¸¸æˆç»Ÿè®¡æ•°æ®
            gameStats.energyAbsorptions++;

            const head = snake[0];
            const absorptionRange = 5; // å¸æ”¶èŒƒå›´

            // åˆ›å»ºå¸æ”¶ç‰¹æ•ˆ
            createAbsorptionEffect(head.x, head.y);

            // æ”¶é›†èŒƒå›´å†…çš„æ‰€æœ‰é£Ÿç‰©
            let absorbedFoods = [];
            for (let i = foods.length - 1; i >= 0; i--) {
                const food = foods[i];
                const distance = Math.abs(food.x - head.x) + Math.abs(food.y - head.y);

                if (distance <= absorptionRange) {
                    absorbedFoods.push(food);
                    foods.splice(i, 1);

                    // è®¡ç®—å¾—åˆ†
                    score += food.type.points * level * 2; // ç‰¹æŠ€å¾—åˆ†ä¸º2å€

                    // å¢åŠ å‡çº§åˆ†æ•°ï¼ˆå¸æ”¶ç‰¹æŠ€ä¹Ÿä¸ºåŒå€å‡çº§åˆ†æ•°ï¼‰
                    addUpgradeScore(food.type.points * 2);

                    // åˆ›å»ºé£Ÿç‰©å¸æ”¶åŠ¨ç”»
                    createFoodAbsorption(food.x, food.y, head.x, head.y, food.type.color);
                }
            }

            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            scoreElement.textContent = score;

            // æ˜¾ç¤ºå¸æ”¶æ•ˆæœ
            showAbsorptionInfo(absorbedFoods.length);

            // æ¸…ç©ºæ°”æ§½
            energyLevel = 0;
            updateEnergyDisplay();

            // æ£€æŸ¥æˆå°±è§£é”
            checkAchievements();

            // å»¶è¿Ÿåæ¢å¤æ­£å¸¸çŠ¶æ€
            setTimeout(() => {
                isAbsorbing = false;
            }, 1500);
        }

        // åˆ›å»ºå¸æ”¶ç‰¹æ•ˆ
        function createAbsorptionEffect(x, y) {
            const rect = canvas.getBoundingClientRect();
            const effect = document.createElement('div');
            effect.className = 'absorption-effect';
            effect.style.left = (rect.left + x * gridSize + gridSize/2) + 'px';
            effect.style.top = (rect.top + y * gridSize + gridSize/2) + 'px';
            effect.style.width = (gridSize * 10) + 'px';
            effect.style.height = (gridSize * 10) + 'px';
            effect.style.background = 'radial-gradient(circle, rgba(78, 201, 176, 0.8) 0%, rgba(77, 166, 255, 0.6) 50%, transparent 100%)';
            effect.style.borderRadius = '50%';
            effect.style.animation = 'absorptionAnimation 1.5s ease-out forwards';

            gameArea.appendChild(effect);

            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
            }, 1500);
        }

        // åˆ›å»ºé£Ÿç‰©å¸æ”¶åŠ¨ç”»
        function createFoodAbsorption(fromX, fromY, toX, toY, color) {
            const rect = canvas.getBoundingClientRect();
            const foodElement = document.createElement('div');
            foodElement.className = 'food-absorption';
            foodElement.style.left = (rect.left + fromX * gridSize + gridSize/2) + 'px';
            foodElement.style.top = (rect.top + fromY * gridSize + gridSize/2) + 'px';
            foodElement.style.width = gridSize + 'px';
            foodElement.style.height = gridSize + 'px';
            foodElement.style.background = color;
            foodElement.style.borderRadius = '50%';
            foodElement.style.fontSize = '16px';
            foodElement.style.textAlign = 'center';
            foodElement.style.lineHeight = gridSize + 'px';
            foodElement.textContent = 'âœ¨';

            gameArea.appendChild(foodElement);

            // è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                foodElement.style.left = (rect.left + toX * gridSize + gridSize/2) + 'px';
                foodElement.style.top = (rect.top + toY * gridSize + gridSize/2) + 'px';
                foodElement.style.transform = 'scale(0)';
                foodElement.style.opacity = '0';
            }, 50);

            setTimeout(() => {
                if (foodElement.parentNode) {
                    foodElement.parentNode.removeChild(foodElement);
                }
            }, 500);
        }

        // æ˜¾ç¤ºå¸æ”¶ä¿¡æ¯
        function showAbsorptionInfo(count) {
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '50%';
            info.style.left = '50%';
            info.style.transform = 'translate(-50%, -50%)';
            info.style.color = '#4ec9b0';
            info.style.fontSize = '24px';
            info.style.fontWeight = 'bold';
            info.style.textAlign = 'center';
            info.style.zIndex = '2000';
            info.style.animation = 'absorptionAnimation 1s ease-out forwards';
            info.innerHTML = `ABSORBED!<br><span style="font-size: 16px; color: #858585;">${count} foods x2 score</span>`;

            gameArea.appendChild(info);

            setTimeout(() => {
                if (info.parentNode) {
                    info.parentNode.removeChild(info);
                }
            }, 1000);
        }

        // åˆå§‹åŒ–å‡çº§è¿›åº¦æ¡
        function initUpgradeBar() {
            updateUpgradeDisplay();
        }

        // æ›´æ–°å‡çº§è¿›åº¦æ˜¾ç¤º
        function updateUpgradeDisplay() {
            const fillPercentage = (upgradeScore / upgradeThreshold) * 100;
            upgradeFill.style.width = fillPercentage + '%';
            upgradeCurrent.textContent = upgradeScore;

            // æ˜¾ç¤º/éšè—å‡çº§å°±ç»ªæç¤º
            if (upgradeScore >= upgradeThreshold) {
                upgradeReady.style.display = 'block';
            } else {
                upgradeReady.style.display = 'none';
            }
        }

        // å¢åŠ å‡çº§åˆ†æ•°
        function addUpgradeScore(points) {
            const previousScore = upgradeScore;
            upgradeScore += points;

            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å‡çº§é˜ˆå€¼
            if (previousScore < upgradeThreshold && upgradeScore >= upgradeThreshold) {
                triggerUpgradeBonus();
            }

            updateUpgradeDisplay();
        }

        // è§¦å‘å‡çº§å¥–åŠ±
        function triggerUpgradeBonus() {
            upgradeBonusCount++;

            // æ˜¾ç¤ºå‡çº§ç‰¹æ•ˆ
            showUpgradeEffect();

            // ç»™äºˆå¥–åŠ±ï¼šå¯ä»¥æ˜¯ä¸€äº›ç‰¹æ®Šæ•ˆæœï¼Œæ¯”å¦‚æš‚æ—¶æ— æ•Œã€é¢å¤–åˆ†æ•°ç­‰
            score += 50; // é¢å¤–å¥–åŠ±åˆ†æ•°
            scoreElement.textContent = score;

            // é‡ç½®å‡çº§è¿›åº¦
            upgradeScore = 0;
            updateUpgradeDisplay();
        }

        // æ˜¾ç¤ºå‡çº§ç‰¹æ•ˆ
        function showUpgradeEffect() {
            const effect = document.createElement('div');
            effect.className = 'upgrade-effect';
            effect.innerHTML = `
                <div>ğŸ‰ UPGRADE! ğŸ‰</div>
                <div style="font-size: 24px; margin-top: 10px;">Bonus +50</div>
                <div style="font-size: 16px; margin-top: 5px;">Total Upgrades: ${upgradeBonusCount}</div>
            `;
            effect.style.animation = 'upgradeAnimation 2s ease-out forwards';

            gameArea.appendChild(effect);

            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
            }, 2000);
        }

        // åˆå§‹åŒ–çš®è‚¤ç³»ç»Ÿ
        function initSkinSystem() {
            // åŠ è½½å·²è§£é”çš„çš®è‚¤
            loadUnlockedSkins();

            // åŠ è½½å½“å‰é€‰æ‹©çš„çš®è‚¤
            currentSkin = localStorage.getItem('snakeCurrentSkin') || 'default';

            // æ›´æ–°æœ€ä½³ç­‰çº§æ˜¾ç¤º
            bestLevelElement.textContent = historicalMaxLevel;

            // æ›´æ–°çš®è‚¤é€‰æ‹©å™¨
            updateSkinSelector();
        }

        // åŠ è½½å·²è§£é”çš„çš®è‚¤
        function loadUnlockedSkins() {
            unlockedSkins = JSON.parse(localStorage.getItem('snakeUnlockedSkins') || '["default"]');

            // æ›´æ–°çš®è‚¤æ•°ç»„
            snakeSkins.forEach(skin => {
                skin.unlocked = unlockedSkins.includes(skin.id);
            });
        }

        // ä¿å­˜å·²è§£é”çš„çš®è‚¤
        function saveUnlockedSkins() {
            localStorage.setItem('snakeUnlockedSkins', JSON.stringify(unlockedSkins));
        }

        // æ£€æŸ¥çš®è‚¤è§£é”
        function checkSkinUnlocks(newLevel) {
            let newlyUnlockedSkins = [];

            snakeSkins.forEach(skin => {
                if (!skin.unlocked && shouldUnlockSkin(skin.id, newLevel)) {
                    skin.unlocked = true;
                    newlyUnlockedSkins.push(skin);
                    if (!unlockedSkins.includes(skin.id)) {
                        unlockedSkins.push(skin.id);
                    }
                }
            });

            if (newlyUnlockedSkins.length > 0) {
                saveUnlockedSkins();
                // æ˜¾ç¤ºæœ€æ–°çš„çš®è‚¤è§£é”
                const latestSkin = newlyUnlockedSkins[newlyUnlockedSkins.length - 1];
                showSkinUnlock(latestSkin, newLevel);
            }

            return newlyUnlockedSkins;
        }

        // åˆ¤æ–­æ˜¯å¦åº”è¯¥è§£é”çš®è‚¤
        function shouldUnlockSkin(skinId, level) {
            const unlockRequirements = {
                'fire': 6,
                'ice': 8,
                'nature': 10,
                'galaxy': 12,
                'rainbow': 15
            };
            return level >= unlockRequirements[skinId];
        }

        // æ˜¾ç¤ºçš®è‚¤è§£é”æç¤º
        function showSkinUnlock(skin, newLevel) {
            // æš‚åœæ¸¸æˆ
            gamePaused = true;

            // æ˜¾ç¤ºè§£é”ä¿¡æ¯
            unlockSkinName.textContent = skin.name;
            unlockDescription.textContent = skin.description;
            newRecordLevel.textContent = newLevel;
            previousRecord.textContent = historicalMaxLevel;
            skinUnlockModal.style.display = 'flex';

            // æ›´æ–°æš‚åœæŒ‰é’®çŠ¶æ€
            if (pauseBtn) {
                pauseBtn.textContent = 'Continue (F6)';
            }
        }

        // å…³é—­çš®è‚¤è§£é”æç¤º
        function closeSkinUnlock() {
            skinUnlockModal.style.display = 'none';

            // æ¢å¤æ¸¸æˆ
            gamePaused = false;

            // æ›´æ–°æš‚åœæŒ‰é’®çŠ¶æ€
            if (pauseBtn) {
                pauseBtn.textContent = 'Pause (F6)';
            }

            // å¦‚æœæ¸¸æˆè¿˜åœ¨è¿è¡Œï¼Œæ¢å¤æ¸¸æˆå¾ªç¯
            if (gameRunning) {
                gameLoop();
            }
        }

        // æ›´æ–°çš®è‚¤é€‰æ‹©å™¨
        function updateSkinSelector() {
            const skinGrid = document.getElementById('skinGrid');
            skinGrid.innerHTML = '';

            snakeSkins.forEach(skin => {
                const skinCard = document.createElement('div');
                skinCard.className = `skin-card ${skin.unlocked ? '' : 'locked'} ${currentSkin === skin.id ? 'selected' : ''}`;

                skinCard.innerHTML = `
                    <div class="skin-preview">${skin.logo}</div>
                    <div class="skin-name">${skin.name}</div>
                    <div class="skin-description">${skin.description}</div>
                    <div class="skin-status ${skin.unlocked ? 'unlocked' : 'locked'}">
                        ${skin.unlocked ? 'å·²è§£é”' : 'æœªè§£é”'}
                    </div>
                    ${skin.unlocked ? `<button class="skin-button" onclick="selectSkin('${skin.id}')">é€‰æ‹©</button>` : ''}
                `;

                skinGrid.appendChild(skinCard);
            });
        }

        // é€‰æ‹©çš®è‚¤
        function selectSkin(skinId) {
            if (unlockedSkins.includes(skinId)) {
                currentSkin = skinId;
                localStorage.setItem('snakeCurrentSkin', skinId);
                updateSkinSelector();
            }
        }

        // æ˜¾ç¤ºçš®è‚¤é€‰æ‹©å™¨
        function showSkinSelector() {
            skinSelector.style.display = 'block';
        }

        // å…³é—­çš®è‚¤é€‰æ‹©å™¨
        function closeSkinSelector() {
            skinSelector.style.display = 'none';
        }

        // è·å–æ’è¡Œæ¦œæ•°æ®
        function getLeaderboard() {
            return leaderboardData[currentDifficulty] || [];
        }

        // æ˜¾ç¤ºæ¸¸æˆç»“æŸæ’è¡Œæ¦œ
        function showGameOverLeaderboard() {
            try {
                const gameOverLeaderboard = document.getElementById('gameOverLeaderboard');
                if (!gameOverLeaderboard) {
                    console.error('gameOverLeaderboard element not found');
                    return;
                }

                const leaderboard = getLeaderboard();
                if (!leaderboard) {
                    console.error('Leaderboard data not available');
                    return;
                }

                gameOverLeaderboard.innerHTML = '';

            // åªæ˜¾ç¤ºå‰5å
            const top5 = leaderboard.slice(0, 5);

            top5.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-preview-item';

                // å¦‚æœæ˜¯å½“å‰ç©å®¶ï¼Œé«˜äº®æ˜¾ç¤º
                if (entry.name === currentPlayer && entry.score === score) {
                    item.classList.add('leaderboard-preview-current');
                }

                item.innerHTML = `
                    <div class="leaderboard-preview-rank">#${index + 1}</div>
                    <div class="leaderboard-preview-name">${entry.name}</div>
                    <div class="leaderboard-preview-score">${entry.score}</div>
                `;

                gameOverLeaderboard.appendChild(item);
            });

            // å¦‚æœå½“å‰ç©å®¶ä¸åœ¨å‰5åï¼Œä½†åˆ†æ•°å¤§äº0ï¼Œæ˜¾ç¤ºå½“å‰ç©å®¶
            if (currentPlayer !== 'Guest' && score > 0) {
                const currentPlayerRank = leaderboard.findIndex(entry => entry.name === currentPlayer && entry.score === score);
                if (currentPlayerRank >= 5) {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-preview-item leaderboard-preview-current';
                    item.innerHTML = `
                        <div class="leaderboard-preview-rank">#${currentPlayerRank + 1}</div>
                        <div class="leaderboard-preview-name">${currentPlayer}</div>
                        <div class="leaderboard-preview-score">${score}</div>
                    `;
                    gameOverLeaderboard.appendChild(item);
                }
            }
            } catch (error) {
                console.error('Error in showGameOverLeaderboard:', error);
            }
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            gameOverElement.style.display = 'none';
            startGame();
        }

        // æ˜¾ç¤ºå®Œæ•´æ’è¡Œæ¦œ
        function showFullLeaderboard() {
            gameOverElement.style.display = 'none';
            showLeaderboard();
        }

        // ç§°å·ç³»ç»Ÿ - æ ¹æ®ç­‰çº§æ›´æ–°ç©å®¶ç§°å·
        function updatePlayerTitle(level) {
            const titles = {
                1: "ğŸŒ± è›‡å®å®",
                2: "ğŸ å°é’è›‡",
                3: "ğŸŒ¿ ç»¿å¶è›‡",
                4: "âš¡ é—ªç”µè›‡",
                5: "ğŸ”¥ ç«ç„°è›‡",
                6: "â„ï¸ å†°éœœè›‡",
                7: "ğŸŒŠ æ³¢æµªè›‡",
                8: "ğŸŒŸ æ˜Ÿå…‰è›‡",
                9: "ğŸ‘‘ ç‹è€…è›‡",
                10: "ğŸ‰ é¾™è›‡",
                12: "âš”ï¸ æˆ˜ç¥è›‡",
                15: "ğŸŒˆ å½©è™¹è›‡",
                20: "ğŸ’ é’»çŸ³è›‡",
                25: "ğŸ”® ç¥ç§˜è›‡",
                30: "ğŸ‘ï¸ å…¨çŸ¥è›‡"
            };

            let currentTitle = "ğŸŒ± è›‡å®å®"; // é»˜è®¤ç§°å·

            // æ‰¾åˆ°å½“å‰ç­‰çº§å¯¹åº”çš„æœ€é«˜ç§°å·
            for (let [minLevel, title] of Object.entries(titles)) {
                if (level >= parseInt(minLevel)) {
                    currentTitle = title;
                }
            }

            // æ›´æ–°ç§°å·æ˜¾ç¤º
            const playerTitle = document.getElementById('playerTitle');
            if (playerTitle) {
                playerTitle.textContent = currentTitle;
            }

            return currentTitle;
        }

        // æˆå°±ç³»ç»Ÿæ•°æ®
        const achievements = [
            {
                id: 'first_level',
                name: 'åˆå‡ºèŒ…åº',
                description: 'è¾¾åˆ°ç­‰çº§2',
                icon: 'ğŸ¯',
                condition: (level, score) => level >= 2,
                unlocked: false
            },
            {
                id: 'speed_demon',
                name: 'é€Ÿåº¦æ¶é­”',
                description: 'åœ¨30ç§’å†…åƒæ‰10ä¸ªé£Ÿç‰©',
                icon: 'âš¡',
                condition: (level, score, gameStats) => gameStats.foodsEatenIn30Seconds >= 10,
                unlocked: false
            },
            {
                id: 'level_master',
                name: 'ç­‰çº§å¤§å¸ˆ',
                description: 'è¾¾åˆ°ç­‰çº§6',
                icon: 'ğŸ†',
                condition: (level, score) => level >= 6,
                unlocked: false
            },
            {
                id: 'score_hunter',
                name: 'åˆ†æ•°çŒæ‰‹',
                description: 'å•å±€å¾—åˆ†è¶…è¿‡500',
                icon: 'ğŸ¯',
                condition: (level, score) => score >= 500,
                unlocked: false
            },
            {
                id: 'bomb_survivor',
                name: 'ç‚¸å¼¹å¹¸å­˜è€…',
                description: 'æ¸¸æˆç»“æŸåå¾—åˆ†ä»ä¸ºæ­£æ•°',
                icon: 'ğŸ’£',
                condition: (level, score, gameStats) => gameStats.bombsHit > 0 && score > 0,
                unlocked: false
            },
            {
                id: 'energy_master',
                name: 'èƒ½é‡å¤§å¸ˆ',
                description: 'å•å±€ä½¿ç”¨èƒ½é‡å¸æ”¶è¶…è¿‡5æ¬¡',
                icon: 'âš¡',
                condition: (level, score, gameStats) => gameStats.energyAbsorptions >= 5,
                unlocked: false
            },
            {
                id: 'level_ten',
                name: 'åçº§ç‹è€…',
                description: 'è¾¾åˆ°ç­‰çº§10',
                icon: 'ğŸ‘‘',
                condition: (level, score) => level >= 10,
                unlocked: false
            },
            {
                id: 'perfect_game',
                name: 'å®Œç¾æ¸¸æˆ',
                description: 'è¾¾åˆ°ç­‰çº§15ä¸”æ²¡æœ‰æ’åˆ°ä»»ä½•ç‚¸å¼¹',
                icon: 'â­',
                condition: (level, score, gameStats) => level >= 15 && gameStats.bombsHit === 0,
                unlocked: false
            },
            {
                id: 'food_collector',
                name: 'é£Ÿç‰©æ”¶é›†è€…',
                description: 'å•å±€åƒæ‰100ä¸ªé£Ÿç‰©',
                icon: 'ğŸ',
                condition: (level, score, gameStats) => gameStats.totalFoodsEaten >= 100,
                unlocked: false
            },
            {
                id: 'legendary_snake',
                name: 'ä¼ å¥‡è´ªåƒè›‡',
                description: 'è¾¾åˆ°ç­‰çº§20',
                icon: 'ğŸ‰',
                condition: (level, score) => level >= 20,
                unlocked: false
            }
        ];

        // æ¸¸æˆç»Ÿè®¡æ•°æ®
        let gameStats = {
            foodsEatenIn30Seconds: 0,
            foodTimer: 0,
            energyAbsorptions: 0,
            bombsHit: 0,
            totalFoodsEaten: 0,
            gameStartTime: 0
        };

        // åŠ è½½å·²è§£é”çš„æˆå°±
        function loadAchievements() {
            const savedAchievements = localStorage.getItem('snakeAchievements');
            if (savedAchievements) {
                const unlockedIds = JSON.parse(savedAchievements);
                achievements.forEach(achievement => {
                    achievement.unlocked = unlockedIds.includes(achievement.id);
                });
            }
        }

        // ä¿å­˜å·²è§£é”çš„æˆå°±
        function saveAchievements() {
            const unlockedIds = achievements.filter(a => a.unlocked).map(a => a.id);
            localStorage.setItem('snakeAchievements', JSON.stringify(unlockedIds));
        }

        // æ£€æŸ¥æˆå°±è§£é”æ¡ä»¶
        function checkAchievements() {
            const newlyUnlocked = [];

            achievements.forEach(achievement => {
                if (!achievement.unlocked) {
                    try {
                        if (achievement.condition(level, score, gameStats)) {
                            achievement.unlocked = true;
                            newlyUnlocked.push(achievement);
                        }
                    } catch (e) {
                        // æˆå°±æ¡ä»¶æ£€æŸ¥å¤±è´¥ï¼Œè·³è¿‡
                    }
                }
            });

            if (newlyUnlocked.length > 0) {
                saveAchievements();
                // æ˜¾ç¤ºæˆå°±è§£é”é€šçŸ¥
                newlyUnlocked.forEach((achievement, index) => {
                    setTimeout(() => {
                        showAchievementUnlock(achievement);
                    }, index * 1000); // é”™å¼€æ˜¾ç¤ºæ—¶é—´
                });
            }

            return newlyUnlocked.length > 0;
        }

        // æ˜¾ç¤ºæˆå°±è§£é”ç‰¹æ•ˆ
        function showAchievementUnlock(achievement) {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-content">
                    <div class="achievement-title">æˆå°±è§£é”ï¼</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-description">${achievement.description}</div>
                </div>
            `;

            document.body.appendChild(notification);

            // æ·»åŠ CSSåŠ¨ç”»
            notification.style.animation = 'achievementSlideIn 0.5s ease-out';

            // 3ç§’åå¼€å§‹æ·¡å‡º
            setTimeout(() => {
                notification.style.animation = 'achievementSlideOut 0.5s ease-out forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        }

        // é‡ç½®æ¸¸æˆç»Ÿè®¡æ•°æ®
        function resetGameStats() {
            gameStats = {
                foodsEatenIn30Seconds: 0,
                foodTimer: 0,
                energyAbsorptions: 0,
                bombsHit: 0,
                totalFoodsEaten: 0,
                gameStartTime: Date.now()
            };
        }

        // æ›´æ–°æ¸¸æˆç»Ÿè®¡æ•°æ®
        function updateGameStats() {
            // æ›´æ–°30ç§’å†…åƒé£Ÿç‰©æ•°é‡
            if (Date.now() - gameStats.gameStartTime < 30000) {
                // 30ç§’å†…çš„è®¡æ—¶å™¨é€»è¾‘
            } else {
                gameStats.foodsEatenIn30Seconds = 0;
            }
        }

        // åˆå§‹åŒ–æˆå°±ç³»ç»Ÿ
        function initAchievementSystem() {
            loadAchievements();
        }

        // åˆå§‹åŒ–éš¾åº¦ç³»ç»Ÿ
        function initDifficultySystem() {
            // æ•°æ®è¿ç§»ï¼šå°†æ—§çš„æ’è¡Œæ¦œæ•°æ®è¿ç§»åˆ°æ ‡å‡†æ¨¡å¼
            migrateLegacyLeaderboardData();

            // ç»‘å®šéš¾åº¦é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.difficulty-card').forEach(card => {
                card.addEventListener('click', () => {
                    // ç§»é™¤å…¶ä»–å¡ç‰‡çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.difficulty-card').forEach(c => c.classList.remove('selected'));
                    // æ·»åŠ å½“å‰å¡ç‰‡çš„é€‰ä¸­çŠ¶æ€
                    card.classList.add('selected');
                    // ä¿å­˜é€‰æ‹©çš„éš¾åº¦
                    currentDifficulty = card.dataset.difficulty;
                });
            });

            // ç»‘å®šç¡®è®¤éš¾åº¦æŒ‰é’®
            confirmDifficultyBtn.addEventListener('click', confirmDifficulty);

            // ç»‘å®šè¿”å›æŒ‰é’®
            backToNameBtn.addEventListener('click', backToNameInput);

            // éšè—éš¾åº¦é€‰æ‹©ç•Œé¢
            difficultySelect.style.display = 'none';
        }

        // æ•°æ®è¿ç§»ï¼šå°†æ—§çš„æ’è¡Œæ¦œæ•°æ®è¿ç§»åˆ°æ ‡å‡†æ¨¡å¼
        function migrateLegacyLeaderboardData() {
            const legacyData = localStorage.getItem('snakeLeaderboard');
            if (legacyData && !localStorage.getItem('snakeLeaderboard_standard')) {
                try {
                    const parsedData = JSON.parse(legacyData);
                    // ä¸ºæ—§æ•°æ®æ·»åŠ éš¾åº¦ä¿¡æ¯ï¼Œé»˜è®¤ä¸ºæ ‡å‡†æ¨¡å¼
                    const migratedData = parsedData.map(entry => ({
                        ...entry,
                        difficulty: 'standard',
                        difficultyName: 'æ ‡å‡†æ¨¡å¼'
                    }));
                    leaderboardData.standard = migratedData;
                    localStorage.setItem('snakeLeaderboard_standard', JSON.stringify(migratedData));
                    console.log('æˆåŠŸè¿ç§»æ’è¡Œæ¦œæ•°æ®åˆ°æ ‡å‡†æ¨¡å¼');
                } catch (e) {
                    console.error('è¿ç§»æ’è¡Œæ¦œæ•°æ®å¤±è´¥:', e);
                }
            }
        }

        // ç¡®è®¤éš¾åº¦é€‰æ‹©
        function confirmDifficulty() {
            currentPlayer = tempPlayerName;
            playerNameElement.textContent = currentPlayer;

            // æ›´æ–°éš¾åº¦æ˜¾ç¤º
            const gameDifficulty = document.getElementById('gameDifficulty');
            if (gameDifficulty) {
                const config = difficultyConfig[currentDifficulty];
                gameDifficulty.textContent = `${config.icon} ${config.name}`;
                gameDifficulty.style.color = config.color;
            }

            difficultySelect.style.display = 'none';
            gameStarted = true;
            startGame();
        }

        // è¿”å›åç§°è¾“å…¥
        function backToNameInput() {
            difficultySelect.style.display = 'none';
            playerInput.style.display = 'flex';
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        initEnergyBar();
        initUpgradeBar();
        initSkinSystem();
        initAchievementSystem();
        initDifficultySystem();
        generateFoods();
        draw();
    </script>
</body>
</html>